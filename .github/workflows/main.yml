name: Release Tests & Publish

on:
  push:
    branches: [ master ]

permissions:
  contents: write
  checks: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout for CI ðŸ›Žï¸'
        uses: actions/checkout@v4
        
      - name: 'Set up JDK 21 ðŸ“¦'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: 'Build with Gradle ðŸ—ï¸'
        uses: gradle/gradle-build-action@v3
        with:
          arguments: build test
          
      - name: 'Publish Test Report ðŸ“Š'
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          report_paths: '**/build/test-results/test/TEST-*.xml'
          
      - name: 'Get next version ðŸ·ï¸'
        id: version
        run: |
          echo "VERSION=v1.0.$(date +%s)" >> $GITHUB_OUTPUT
          
      - name: 'Create Release and Upload Assets ðŸš€'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/HuskSync-Bukkit-${{ steps.version.outputs.VERSION }}+mc.1.20.1.jar
            target/HuskSync-Bukkit-${{ steps.version.outputs.VERSION }}+mc.1.21.1.jar
            target/HuskSync-Bukkit-${{ steps.version.outputs.VERSION }}+mc.1.21.4.jar
            target/HuskSync-Bukkit-${{ steps.version.outputs.VERSION }}+mc.1.21.5.jar
            target/HuskSync-Bukkit-${{ steps.version.outputs.VERSION }}+mc.1.21.8.jar
            target/HuskSync-Fabric-${{ steps.version.outputs.VERSION }}+mc.1.20.1.jar
            target/HuskSync-Fabric-${{ steps.version.outputs.VERSION }}+mc.1.21.1.jar
            target/HuskSync-Fabric-${{ steps.version.outputs.VERSION }}+mc.1.21.4.jar
            target/HuskSync-Fabric-${{ steps.version.outputs.VERSION }}+mc.1.21.5.jar
            target/HuskSync-Fabric-${{ steps.version.outputs.VERSION }}+mc.1.21.8.jar
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            Automated release
            
            ## Changes
            - Built from commit: ${{ github.sha }}
            - Build time: $(date -u)
            
            ## Supported Minecraft Versions
            - Paper 1.20.1, 1.21.1, 1.21.4, 1.21.5, 1.21.8
            - Fabric 1.20.1, 1.21.1, 1.21.4, 1.21.5, 1.21.8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
